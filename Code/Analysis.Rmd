---
title: "Prediction model for permanent hypoparathyroidism"
author: "Carolien C.H.M. Maas, Erasmus MC, Rotterdam, The Netherlands"
date: "June 2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Load packages, functions, and data
```{r, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
# erase memory
rm(list = ls(all.names = TRUE))

# for reproducibility
seed <- 2
set.seed(seed)

# load libraries
library(haven)
library(dplyr)
library(mice)
library(rms)
```

# Load data
```{r, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
file.path <- "Z:/Project Predict Hypoparathyroidism/"
original.data <- read.csv(paste0(file.path, "Data/Data.csv"), 
                 stringsAsFactors=TRUE,
                 header = T, sep = ";", dec = ".", 
                 na.strings = c("", " ", "NA", "999", 999, "999.00", 999.00, 
                                "Missing", "missing"))

# variable selection
cvar <- c("Record_ID", "Readmission","HypoP", "surgery_type", "Sex", # "Indicatie",
          "BSKgezien",  "CHKD", "BSKinPA", "PostPA", "PostOPCa", "Validatie1") #, "Center", "Validatie")
nvar <- c("BaselinePTH", "PTH24u", "BaseCa", "Basealbu", "Ca24u", "Albu24u",
           "Age_Years")
work.data <- original.data[c(cvar, nvar)]
```

# Data cleaning
```{r, eval=TRUE}
# coding of variables
work.data$HypoP <- ifelse(work.data$HypoP %in% c("No ", "No"), "No", "Yes")
work.data$HypoP <- as.factor(work.data$HypoP)
work.data$PostOPCa <- ifelse(work.data$PostOPCa %in% c("No ", "No"), "No", "Yes")
work.data$PostOPCa <- as.factor(work.data$PostOPCa)
work.data$Age_Years <- as.numeric(work.data$Age_Years)

# replace , by .
work.data$BaselinePTH <- gsub(",", ".", work.data$BaselinePTH)
work.data$BaselinePTH <- as.numeric(work.data$BaselinePTH)
work.data$PTH24u <- gsub(",", ".", work.data$PTH24u)
work.data$PTH24u <- as.numeric(work.data$PTH24u)
work.data$BaseCa <- gsub(",", ".", work.data$BaseCa)
work.data$BaseCa <- as.numeric(work.data$BaseCa)
work.data$Basealbu <- gsub(",", ".", work.data$Basealbu)
work.data$Basealbu <- as.numeric(work.data$Basealbu)
work.data$Ca24u <- gsub(",", ".", work.data$Ca24u)
work.data$Ca24u <- as.numeric(work.data$Ca24u)
work.data$Albu24u <- gsub(",", ".", work.data$Albu24u)
work.data$Albu24u <- as.numeric(work.data$Albu24u)
```

# Imputation
```{r, eval=TRUE}
# single imputation is fine since less than 10% is missing
colMeans(is.na(work.data))*100
save(work.data, file=paste0(file.path, "/Data/data.to.be.imputed.Rdata"))

# set-up imputation
miceHypoP <- mice(work.data, maxit = 0)
miceHypoPmeth <- miceHypoP$meth
miceHypoPpred <- miceHypoP$pred
miceHypoP

## will not be used as predictor in model
miceHypoPpred[, "Record_ID"] <- 0

# single imputation
m <- 1
mi <- mice::mice(work.data, m = m, seed = seed,
           method=miceHypoPmeth,
           predictorMatrix=miceHypoPpred,
           print=FALSE)
```

# Berekenen PTH daling, gecorrigeerd calcium en gecorrigeerd calcium daling
```{r, eval=TRUE}
# imputed data in long format
mi_long <- mice::complete(mi, action = "long", include = T)

# calculate delta PTH, delta Ca, and delta CorrCa
mi_long$dPTH <- ((mi_long$BaselinePTH - mi_long$PTH24u)/mi_long$BaselinePTH*100)
mi_long$CorrCaBaseline <- mi_long$BaseCa +((34-mi_long$Basealbu)*0.016)
mi_long$CorrCa24u <- mi_long$Ca24u +((34-mi_long$Albu24u)*0.016)
mi_long$dCorrCa24u <- ((mi_long$CorrCaBaseline - mi_long$CorrCa24u)/mi_long$CorrCaBaseline*100)
mi_long$dCa24u <- ((mi_long$BaseCa - mi_long$Ca24u)/mi_long$BaseCa*100)

# relevel
# mi_long$BSKnietgezien <- ifelse(mi_long$BSKgezien=="Yes", "No", ifelse(mi_long$BSKgezien=="No", "Yes", NA))
# mi_long$BSKnietgezien <- as.factor(mi_long$BSKnietgezien)

# imputed data into mice format
imputed.data <- as.mids(mi_long)

# set data distributions
dd<-rms::datadist(mice::complete(imputed.data, m))
options(datadist='dd')
options(digits=8)
```

# 1. Functional form - possible predictors
```{r, eval=TRUE, warning=FALSE}
# all possible predictors
# include either PTH24u or dPTH
# include either Ca24u or CorrCa24u or dCa24u or dCorrCa24u
functional.forms <- list(
  "PTH24u + Ca24u",
  "PTH24u + CorrCa24u",
  "PTH24u + dCa24u",
  "PTH24u + dCorrCa24u",
  "dPTH + Ca24u",
  "dPTH + CorrCa24u", # BEST and clinically most practical
  "dPTH + dCa24u",
  "dPTH + dCorrCa24u")
model.AICs <- c()
model.BICs <- c()
for (functional.form in functional.forms){
  form <- eval(parse(text=paste("HypoP ~", functional.form, "+ Age_Years + Sex + surgery_type + BSKgezien + CHKD")))
  model <- glm(form, data=mice::complete(imputed.data, m), family="binomial")
  model.AICs <- c(model.AICs, model$aic)
}
possible.predictors.df <- as.data.frame(cbind(functional.forms, sprintf("%.1f", model.AICs)))
openxlsx::write.xlsx(possible.predictors.df,
            rowNames=FALSE,
            file=paste0(file.path, "/Results/functional.form.xlsx"))
print(cbind(functional.forms, model.AICs))
cat("Minimum AIC:", which(model.AICs==min(model.AICs)))

# Warning message means that we predict exact 0 and 1 due to smalls ample size (see https://www.statology.org/glm-fit-fitted-probabilities-numerically-0-or-1-occurred/)
```
# 2. Functional form - flexibility
```{r, eval=TRUE, warning=FALSE}
# plot most flexible model
form.flexible.model <- HypoP ~ rms::rcs(dPTH, 4) + 
  rms::rcs(CorrCa24u, 4) + 
  rms::rcs(Age_Years, 4) + 
  Sex + 
  surgery_type + 
  BSKgezien + 
  CHKD
flexible.model <- rms::lrm(form.flexible.model, data=mice::complete(imputed.data, m), maxit=1000, x=TRUE, y=TRUE)
grDevices::png(file=paste0(file.path, "Results/plot.Predict.png"))
plot(Predict(flexible.model))
grDevices::dev.off()

# check if dPTH, CorrCa or age need to be modelled non-linearly
functional.forms <- list(
  "dPTH + CorrCa24u + Age_Years", # RIGID MODEL
  "rms::rcs(dPTH, 3) + CorrCa24u + Age_Years", 
  "rms::rcs(dPTH, 4) + CorrCa24u + Age_Years", # BEST
  "rms::rcs(dPTH, 5) + CorrCa24u + Age_Years", 
  "dPTH + rms::rcs(CorrCa24u, 3) + Age_Years",
  "dPTH + rms::rcs(CorrCa24u, 4) + Age_Years",
  "dPTH + rms::rcs(CorrCa24u, 5) + Age_Years",
  "dPTH + CorrCa24u + rms::rcs(Age_Years, 3)", 
  "dPTH + CorrCa24u + rms::rcs(Age_Years, 4)", 
  "dPTH + CorrCa24u + rms::rcs(Age_Years, 5)", 
  "rms::rcs(dPTH, 4) + rms::rcs(CorrCa24u, 3) + Age_Years",
  "rms::rcs(dPTH, 4) + CorrCa24u + rms::rcs(Age_Years, 3)",
  "dPTH + rms::rcs(CorrCa24u, 3) + rms::rcs(Age_Years, 3)",
  "rms::rcs(dPTH, 4) + rms::rcs(CorrCa24u, 3) + rms::rcs(Age_Years, 3)") 
model.AICs <- c()
for (functional.form in functional.forms){
  form <- eval(parse(text=paste("HypoP ~", functional.form, "+ Sex + surgery_type + BSKgezien + CHKD")))
  model <- glm(form, data=mice::complete(imputed.data, m), family="binomial")
  model.AICs <- c(model.AICs, model$aic)
}
flexibility.df <- as.data.frame(cbind(functional.forms, sprintf("%.1f", model.AICs)))
openxlsx::write.xlsx(flexibility.df,
            rowNames=FALSE,
            file=paste0(file.path, "/Results/flexibility.xlsx"))
print(cbind(functional.forms, model.AICs))
cat("Minimum AIC:", which(model.AICs==min(model.AICs)))
```
# Full model
```{r, eval=TRUE, warning=FALSE}
# linear
form.full.model <- HypoP ~ dPTH + 
  BSKgezien + 
  CorrCa24u + 
  Age_Years + 
  Sex +
  surgery_type +
  CHKD
full.model <- rms::lrm(form.full.model, data=mice::complete(imputed.data, m), x=TRUE, y=TRUE)

best.flexible.model <-  glm("HypoP ~ rms::rcs(dPTH, 4) + CorrCa24u + Age_Years + Sex + surgery_type + BSKgezien + CHKD", data=mice::complete(imputed.data, m), family="binomial")
lrtest(best.flexible.model, full.model)
```

# Calculate optimism using bootstrap using full model and doing backward selection for each bootstrap
```{r, eval=TRUE, warning=FALSE}
# for single imputation
v<-rms::validate(full.model,method="boot",bw=TRUE,rule="p",sls=0.05,B=100,pr=FALSE,type="individual")

# Show shrinkage factor
shrinkage.factor <- v["Slope","test"]
cat("Shrinkage factor     :", shrinkage.factor, "\n")

# Optimism corrected C-index
cindex.orig<-(v["Dxy","index.orig"]+1)/2   # original C-index
optimism.C<-v["Dxy","optimism"]/2          # optimism C-index, /2 because  C.orig - C.B the +1 cancels out
cindex.B<-(v["Dxy","index.corrected"]+1)/2 # index corrected C-index
cat(" Original C          :", cindex.orig, "\n",
    "Optimism            :", optimism.C, "\n",
    "Mean bootstrapped C :", cindex.B, "\n",
    "Optimism corrected C:", cindex.orig-optimism.C, "\n")
```

# Save results of full model
```{r, eval=TRUE}
# new intercept after shrinkage
lp.full <- predict(full.model)
lp.shrunk.full <- shrinkage.factor*lp.full
full.extra <- lrm.fit(y=mice::complete(imputed.data, m)$HypoP,
                      offset=lp.shrunk.full)
full.intercept.extra <- coef(full.extra)[1]
full.intercept.shrunk <- shrinkage.factor*full.model$coefficients["Intercept"]+full.intercept.extra

# check
mean(mice::complete(imputed.data, m)$HypoP=="Yes") # event probability
mean(plogis(lp.shrunk.full+full.intercept.extra))  # same

# save results
an.full <- stats::anova(full.model)
coef.full.model <- shrinkage.factor*summary(full.model, 
                                            dPTH=c(0, 1),
                                            CorrCa24u=c(0, 0.1),
                                            BSKgezien="No")[which(summary(full.model)[, "Type"]==1), c("Effect")]
Int.full.CI.lower <- full.model$coefficients["Intercept"]+qnorm(0.025)*sqrt(diag(full.model$var)[1])
Int.full.CI.upper <- full.model$coefficients["Intercept"]+qnorm(0.975)*sqrt(diag(full.model$var)[1])
CI.full.model <- exp(rbind(c(shrinkage.factor*Int.full.CI.lower+full.intercept.extra, 
                             shrinkage.factor*Int.full.CI.upper+full.intercept.extra), 
                           shrinkage.factor*cbind(coef.full.model+qnorm(0.025)*sqrt(diag(full.model$var)[-1]),
                                                  coef.full.model+qnorm(0.975)*sqrt(diag(full.model$var)[-1]))))
OR.full.model <- exp(c(full.intercept.shrunk, coef.full.model))
```
# Backward selection
```{r, eval=TRUE, warning=FALSE}
form.final.model <- HypoP ~ dPTH + 
  BSKgezien +
  CorrCa24u 
  # Age_Years +
  # Sex +
  # surgery_type +
  # CHKD
final.model <- lrm(form.final.model, data=mice::complete(imputed.data, m))

# new intercept after shrinkage
lp.final <- predict(final.model)
lp.shrunk.final <- shrinkage.factor*lp.final
final.extra <- lrm.fit(y=mice::complete(imputed.data, m)$HypoP,
                      offset=lp.shrunk.final)
final.intercept.extra <- coef(final.extra)[1]
final.intercept.shrunk <- shrinkage.factor*final.model$coefficients["Intercept"]+final.intercept.extra

# check
mean(mice::complete(imputed.data, m)$HypoP=="Yes") # event probability
mean(plogis(lp.shrunk.final+final.intercept.extra))  # same

# save results
an.final <- stats::anova(final.model)
coef.final.model <- shrinkage.factor*summary(final.model, 
                                            dPTH=c(0, 1),
                                            CorrCa24u=c(0, 0.1),
                                            BSKgezien="No")[which(summary(final.model)[, "Type"]==1), c("Effect")]
Int.CI.lower <- final.model$coefficients["Intercept"]+qnorm(0.025)*sqrt(diag(final.model$var)[1])
Int.CI.upper <- final.model$coefficients["Intercept"]+qnorm(0.975)*sqrt(diag(final.model$var)[1])
CI.final.model <- exp(rbind(c(shrinkage.factor*Int.CI.lower+final.intercept.extra, 
                              shrinkage.factor*Int.CI.upper+final.intercept.extra),
                            shrinkage.factor*cbind(coef.final.model+qnorm(0.025)*sqrt(diag(final.model$var)[-1]),
                                                   coef.final.model+qnorm(0.975)*sqrt(diag(final.model$var)[-1]))))
OR.final.model <- exp(c(final.intercept.shrunk, coef.final.model))
```

# Simple model
```{r, eval=TRUE, warning=FALSE}
simple.model <- rms::lrm(HypoP ~ dPTH, data=mice::complete(imputed.data, m))

# new intercept after shrinkage
lp.simple <- predict(simple.model)
lp.shrunk.simple <- shrinkage.factor*lp.simple
simple.extra <- lrm.fit(y=mice::complete(imputed.data, m)$HypoP,
                      offset=lp.shrunk.simple)
simple.intercept.extra <- coef(simple.extra)[1]
simple.intercept.shrunk <- shrinkage.factor*simple.model$coefficients["Intercept"]+simple.intercept.extra

# check
mean(mice::complete(imputed.data, m)$HypoP=="Yes") # event probability
mean(plogis(lp.shrunk.simple+simple.intercept.extra))  # same

# save results
an.simple <- stats::anova(simple.model)
coef.simple.model <- shrinkage.factor*summary(simple.model, 
                                              dPTH=c(0, 1))[which(summary(simple.model)[, "Type"]==1), c("Effect")]
Int.simple.CI.lower <- simple.model$coefficients["Intercept"]+qnorm(0.025)*sqrt(diag(simple.model$var)[1])
Int.simple.CI.upper <- simple.model$coefficients["Intercept"]+qnorm(0.975)*sqrt(diag(simple.model$var)[1])
CI.simple.model <- exp(rbind(c(shrinkage.factor*Int.simple.CI.lower+simple.intercept.extra, 
                               shrinkage.factor*Int.simple.CI.upper+simple.intercept.extra),
                             shrinkage.factor*cbind(coef.simple.model+qnorm(0.025)*sqrt(diag(simple.model$var)[-1]),
                                                    coef.simple.model+qnorm(0.975)*sqrt(diag(simple.model$var)[-1]))))
OR.simple.model <- exp(c(simple.intercept.shrunk, coef.simple.model))
```

# Assess performance
```{r, eval=TRUE, warning=FALSE}
# only dPTH
lp.simple <- predict(simple.model, newdata=mice::complete(imputed.data, m))
png(file=paste0(file.path, "Results/model.performance.simple.model.png"), 
    width=400, height=400, units="px")
out.simple <- PredictionTools::val.prob.mi(lp.mi=lp.simple, y=as.numeric(work.data$HypoP)-1, dist=TRUE)
grDevices::dev.off()
lrtest(simple.model, final.model)

# final model
lp.final <- predict(final.model, newdata=mice::complete(imputed.data, m))
png(file=paste0(file.path, "Results/model.performance.final.model.png"), 
    width=400, height=400, units="px")
out.final <- PredictionTools::val.prob.mi(lp.mi=lp.final, y=as.numeric(work.data$HypoP)-1, dist=TRUE)
grDevices::dev.off()
lrtest(final.model, full.model)

# full model
lp.full <- predict(full.model, newdata=mice::complete(imputed.data, m))
png(file=paste0(file.path, "Results/model.performance.full.model.png"), 
    width=400, height=400, units="px")
out.full <- PredictionTools::val.prob.mi(lp.mi=lp.full, y=as.numeric(work.data$HypoP)-1, dist=TRUE)
grDevices::dev.off()
```
# Save table
```{r, eval=TRUE, warning=FALSE}
OR.table <- data.frame(names=names(full.model$coefficients),
                                coef.full=sprintf("%.3f", OR.full.model),
                                CI.full=c(paste0("[", sprintf("%.3f", CI.full.model[, 1]), "; ", 
                                               sprintf("%.3f", CI.full.model[, 2]), "]")),
                                Chi.full=c("", sprintf("%.1f", an.full[-nrow(an.full), "Chi-Square"])),
                                coef.final=c(sprintf("%.3f", OR.final.model), rep("", 4)),
                                CI.final=c(paste0("[", sprintf("%.3f", CI.final.model[, 1]), "; ", 
                                               sprintf("%.3f", CI.final.model[, 2]), "]"), rep("", 4)),
                                Chi.final=c("", sprintf("%.1f", an.final[-nrow(an.final), "Chi-Square"]),
                                            rep("", 4)),
                                coef.simple=c(sprintf("%.3f", OR.simple.model), rep("", 6)),
                                CI.simple=c(paste0("[", sprintf("%.3f", CI.simple.model[, 1]), "; ", 
                                               sprintf("%.3f", CI.simple.model[, 2]), "]"),
                                            rep("", 6)),
                                Chi.simple=c("", sprintf("%.1f", an.simple[-nrow(an.simple), "Chi-Square"]),
                                             rep("", 6)))
Cindex.table <- c("C-index",
                  sprintf("%.3f", out.full$cindex-optimism.C), 
                  paste0("[", sprintf("%.3f", out.full$cindex.lower-optimism.C), "; ", sprintf("%.3f", out.full$cindex.upper-optimism.C), "]"),
                  "",
                  sprintf("%.3f", out.final$cindex-optimism.C), 
                  paste0("[", sprintf("%.3f", out.final$cindex.lower-optimism.C), "; ", sprintf("%.3f", out.final$cindex.upper-optimism.C), "]"),
                  "",
                  sprintf("%.3f", out.simple$cindex-optimism.C), 
                  paste0("[", sprintf("%.3f", out.simple$cindex.lower-optimism.C), "; ", sprintf("%.3f", out.simple$cindex.upper-optimism.C), "]"),
                  "")
combined.table <- rbind(OR.table, Cindex.table)
final.table <- cbind(combined.table[, 1:4], rep("", nrow(combined.table)),
                     combined.table[, 5:7], rep("", nrow(combined.table)),
                     combined.table[, 8:10])
openxlsx::write.xlsx(final.table,
            rowNames=FALSE,
            file=paste0(file.path, "/Results/model.xlsx"))

```
# Assess leave-one-center-out cross-validation
```{r, eval=TRUE, warning=FALSE}
# 4 splits
table(work.data$Validatie1)

Centers <- levels(work.data$Validatie1)
cuts <- 5
single.imputed.data <- mice::complete(imputed.data, m)
for (type in c("full", "final")){
  cat("Now fitting", type)
  for (j in 1:4){
    # split outcomes for center j and not j
    y.j <- as.numeric(work.data$HypoP[work.data$Validatie1==Centers[j]])-1
    y.notj <- as.numeric(work.data$HypoP[work.data$Validatie1!=Centers[j]])-1
    
    # model form for center j and not j
    form.model <- eval(parse(text=paste0("form.", type, ".model")))
    form.notj <- update(form.model, y.notj  ~ . )
    
    # fit on 3 centers
    # DISCUSS with David: glm.fit: fitted probabilities numerically 0 or 1 occurred (EMC_voor2017 full model, EMC_na2017 en EMC_voor2017 final model)
    model.notj <- glm(form.notj, data=single.imputed.data[work.data$Validatie1!=Centers[j],], family="binomial")
    print(summary(model.notj))

    # make prediction for 1 center
    cat("for center", Centers[j], "\n")
    lp.j <- predict(model.notj, newdata=single.imputed.data[work.data$Validatie1==Centers[j],])

    # make plot
    png(file=paste0(file.path, "Results/Figures/model.performance.", Centers[j], ".png"))
    out.j <- PredictionTools::val.prob.mi(lp.mi=lp.j, y=y.j, main=Centers[j], g=3, dist=TRUE)
    grDevices::dev.off()
  }
}

# combine 4 calibration plots into one
png(file=paste0(file.path, "Results/leave.one.out.cross.validation.png"), width=16, height=16, units="cm", res=300)
par(mar=rep(0, 4))
layout(matrix(1:4, ncol=2, byrow=TRUE))
Centers.val <- rep(1:4, 3)
for (i in 1:4){
  plot(NA, xlim=0:1, ylim=0:1, xaxt="n", yaxt="n", bty="n")
  img <- png::readPNG(paste0(file.path, "Results/Figures/model.performance.", Centers[Centers.val[i]], ".png"))
  rasterImage(img, 0, 0, 1, 1)
}
grDevices::dev.off()
```
